

+++

title = "调试"
description = "调试"
tags = ["it","go"]

+++



# 调试

准备一个项目程序

```shell
$ tree
.
├── go.mod
└── main.go
```

go.mod

```mod
module yuanyatianchi.io/go/tool/debug

go 1.18
```

main.go

```go
package main

import "fmt"

const LoopTimes = 5

func main() {
	nums := Loop(LoopTimes)
	fmt.Println(nums)
}

func Loop(l int) []int {
	nums := make([]int, LoopTimes)
	for i := 0; i < len(nums); i++ {
		nums[i] = i * i
	}
	return nums
}
```

### delve

安装：使用 go install，latest 指定最新发布版本

```shell
go install github.com/go-delve/delve/cmd/dlv@latest
```

`dlv debug <module_main_pkg>` 进入调试模式。module_main_pkg 指定 main（或 test）包，须以 go.mod 中指定的 module 作前缀，如 `dlv debug yuanyatianchi.io/go/tool/debug ` ，进到 main 包所在目录可以不指定直接执行。

```shell
$ dlv debug
Type 'help' for list of commands.

# 以下均采用命令简写

# `break 包.方法` 设置断点。创建了序号为 1 的断点
$(dlv) b main.Loop
Breakpoint 1 set at 0x49676a for main.Loop() ./main.go:12

# `break 文件:行` 设置断点。创建了序号为 2 的断点
$(dlv) b main.go:15
Breakpoint 2 set at 0x4967dc for main.Loop() ./main.go:15

# `condition 断点序号 条件` 设置断点条件。使断点 2 仅在局部变量 i==3 时生效
$(dlv) cond 2 i==3

# `breakpoints` 查看所有断点。delve 默认为 panic 创建了一些无序号断点
$(dlv) bp
Breakpoint runtime-fatal-throw (enabled) at 0x434cc0 for runtime.throw() /root/go/go/src/runtime/panic.go:982 (0)
Breakpoint unrecovered-panic (enabled) at 0x435080 for runtime.fatalpanic() /root/go/go/src/runtime/panic.go:1065 (0)
        print runtime.curg._panic.arg
Breakpoint 1 (enabled) at 0x49676a for main.Loop() ./main.go:12 (0)
Breakpoint 2 (enabled) at 0x4967dc for main.Loop() ./main.go:15 (0)
        cond i == 3

# `continue` 执行到下一个断点，并打印上下代码
$(dlv) c
> main.Loop() ./main.go:12 (hits goroutine(1):1 total:1) (PC: 0x49676a)
     7: func main() {
     8:         nums := Loop(LoopTimes)
     9:         fmt.Println(nums)
    10: }
    11:
=>  12: func Loop(l int) []int {
    13:         nums := make([]int, l)
    14:         for i := 0; i < len(nums); i++ {
    15:                 nums[i] = i * i
    16:         }
    17:         return nums
# 执行到断点 2
$(dlv) c
> main.Loop() ./main.go:15 (hits goroutine(1):1 total:1) (PC: 0x4967dc)
    10: }
    11:
    12: func Loop(l int) []int {
    13:         nums := make([]int, l)
    14:         for i := 0; i < len(nums); i++ {
=>  15:                 nums[i] = i * i
    16:         }
    17:         return nums
    18: }

# `args` 打印参数变量（包括返回变量）
$(dlv) args
l = 5
~r0 = []int len: 0, cap: 0, nil

# `locals` 打印局部变量
$(dlv) locals
nums = []int len: 5, cap: 5, [...]
i = 3

# `vars 包` 打印包变量
$(dlv) vars main
runtime.main_init_done = chan bool 0/0
runtime.mainStarted = true
main.LoopTimes = 5

# `print 变量名` 打印具体变量具体
$(dlv) p nums
[]int len: 5, cap: 5, [0,1,4,0,0]

# `stack` 打印当前执行函数的栈帧信息
$(dlv) stack
0  0x00000000004967dc in main.Loop
   at ./main.go:15
1  0x00000000004966a5 in main.main
   at ./main.go:8
2  0x00000000004373b8 in runtime.main
   at /root/go/go/src/runtime/proc.go:250
3  0x00000000004614e1 in runtime.goexit
   at /root/go/go/src/runtime/asm_amd64.s:1571

# `goroutine` 查看当前 Groutine 信息
$(dlv) gr
Thread 6000 at ./main.go:15
Goroutine 1:
        Runtime: ./main.go:15 main.Loop (0x4967dc)
        User: ./main.go:15 main.Loop (0x4967dc)
        Go: <autogenerated>:1 runtime.newproc (0x463aa5)
        Start: /root/go/go/src/runtime/proc.go:145 runtime.main (0x4371e0)
# `goroutines` 查看所有 Groutine 概况
$(dlv) grs
* Goroutine 1 - User: ./main.go:15 main.Loop (0x4967dc) (thread 6000)
  Goroutine 2 - User: /root/go/go/src/runtime/proc.go:362 runtime.gopark (0x4377d2) [force gc (idle)]
  Goroutine 17 - User: /root/go/go/src/runtime/proc.go:362 runtime.gopark (0x4377d2) [GC sweep wait]
  Goroutine 18 - User: /root/go/go/src/runtime/proc.go:362 runtime.gopark (0x4377d2) [GC scavenge wait]
  Goroutine 19 - User: /root/go/go/src/runtime/proc.go:362 runtime.gopark (0x4377d2) [finalizer wait]
[5 goroutines]

# `exit` 退出调试模式
$(dlv) q
```

更多命令内容如下

```shell
$(dlv) help
The following commands are available:

Running the program:
    call ------------------------ Resumes process, injecting a function call (EXPERIMENTAL!!!)
    continue (alias: c) --------- Run until breakpoint or program termination.
    next (alias: n) ------------- Step over to next source line.
    rebuild --------------------- Rebuild the target executable and restarts it. It does not work if the executable was not built by delve.
    restart (alias: r) ---------- Restart process.
    step (alias: s) ------------- Single step through program.
    step-instruction (alias: si)  Single step a single cpu instruction.
    stepout (alias: so) --------- Step out of the current function.

Manipulating breakpoints:
    break (alias: b) ------- Sets a breakpoint.
    breakpoints (alias: bp)  Print out info for active breakpoints.
    clear ------------------ Deletes breakpoint.
    clearall --------------- Deletes multiple breakpoints.
    condition (alias: cond)  Set breakpoint condition.
    on --------------------- Executes a command when a breakpoint is hit.
    toggle ----------------- Toggles on or off a breakpoint.
    trace (alias: t) ------- Set tracepoint.
    watch ------------------ Set watchpoint.

Viewing program variables and memory:
    args ----------------- Print function arguments.
    display -------------- Print value of an expression every time the program stops.
    examinemem (alias: x)  Examine raw memory at the given address.
    locals --------------- Print local variables.
    print (alias: p) ----- Evaluate an expression.
    regs ----------------- Print contents of CPU registers.
    set ------------------ Changes the value of a variable.
    vars ----------------- Print package variables.
    whatis --------------- Prints type of an expression.

Listing and switching between threads and goroutines:
    goroutine (alias: gr) -- Shows or changes current goroutine
    goroutines (alias: grs)  List program goroutines.
    thread (alias: tr) ----- Switch to the specified thread.
    threads ---------------- Print out info for every traced thread.

Viewing the call stack and selecting frames:
    deferred --------- Executes command in the context of a deferred call.
    down ------------- Move the current frame down.
    frame ------------ Set the current frame, or execute command on a different frame.
    stack (alias: bt)  Print stack trace.
    up --------------- Move the current frame up.

Other commands:
    config --------------------- Changes configuration parameters.
    disassemble (alias: disass)  Disassembler.
    dump ----------------------- Creates a core dump from the current process state
    edit (alias: ed) ----------- Open where you are in $DELVE_EDITOR or $EDITOR
    exit (alias: quit | q) ----- Exit the debugger.
    funcs ---------------------- Print list of functions.
    help (alias: h) ------------ Prints the help message.
    libraries ------------------ List loaded dynamic libraries
    list (alias: ls | l) ------- Show source code.
    source --------------------- Executes a file containing a list of delve commands
    sources -------------------- Print list of source files.
    transcript ----------------- Appends command output to a file.
    types ---------------------- Print list of types

Type help followed by a command for full documentation.
```

### gdb

`gdb <exe_path>` 进入调试模式，main_path 直接指定 main（或 test）所在目录即可，无须 module 前缀，进到 main 包所在目录则可以不指定直接执行。

```shell
$ gdb ./
```

